# =============================================================================
# Docker Swarm Infrastructure - Core Services
# =============================================================================
# Traefik (리버스 프록시) + Cloudflare Tunnel (외부 트래픽 인입)
#
# 아키텍처:
#   Cloudflare Edge → cloudflared → Traefik → 내부 서비스
#
# 사용법:
#   docker stack deploy -c docker-compose.yml core
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Traefik v3 - 리버스 프록시 & 로드밸런서
  # ---------------------------------------------------------------------------
  traefik:
    image: traefik:v3.6
    command:
      # API & 대시보드 (로컬 전용)
      - --api.dashboard=true
      - --api.insecure=true

      # Docker Swarm 프로바이더
      - --providers.swarm=true
      - --providers.swarm.endpoint=unix:///var/run/docker.sock
      - --providers.swarm.exposedByDefault=false
      - --providers.swarm.network=traefik-public

      # 파일 프로바이더 (동적 설정)
      - --providers.file.directory=/etc/traefik/dynamic
      - --providers.file.watch=true

      # 엔트리포인트
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443

      # Prometheus 메트릭
      - --metrics.prometheus=true
      - --metrics.prometheus.addEntryPointsLabels=true
      - --metrics.prometheus.addServicesLabels=true

      # 로깅
      - --log.level=INFO
      - --accesslog=true
      - --accesslog.format=json

    ports:
      - target: 80
        published: 80
        mode: host
      - target: 443
        published: 443
        mode: host
      - target: 8080
        published: 8080
        mode: host

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-certs:/letsencrypt
      - ./configs/traefik:/etc/traefik/dynamic:ro

    networks:
      - traefik-public

    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      labels:
        - traefik.enable=true
        - traefik.http.routers.traefik-dashboard.rule=Host(`traefik.localhost`)
        - traefik.http.routers.traefik-dashboard.service=api@internal
        - traefik.http.routers.traefik-dashboard.entrypoints=web
      resources:
        limits:
          cpus: '0.50'
          memory: 256M
        reservations:
          cpus: '0.10'
          memory: 64M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  # ---------------------------------------------------------------------------
  # Cloudflare Tunnel - Zero Trust 외부 접근
  # ---------------------------------------------------------------------------
  cloudflared:
    image: cloudflare/cloudflared:latest
    command:
      - tunnel
      - --no-autoupdate
      - run
    environment:
      TUNNEL_TOKEN: ${CLOUDFLARE_TUNNEL_TOKEN}

    networks:
      - traefik-public

    deploy:
      mode: replicated
      replicas: 1
      resources:
        limits:
          cpus: '0.20'
          memory: 128M
        reservations:
          cpus: '0.05'
          memory: 64M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

networks:
  traefik-public:
    external: true

volumes:
  traefik-certs:
    driver: local
