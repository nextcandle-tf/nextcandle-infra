# =============================================================================
# Traefik 동적 설정
# =============================================================================
# 미들웨어, TLS 설정 등 런타임에 변경 가능한 설정
# =============================================================================

http:
  # ---------------------------------------------------------------------------
  # 미들웨어 정의
  # ---------------------------------------------------------------------------
  middlewares:
    # 보안 헤더 추가
    security-headers:
      headers:
        frameDeny: true
        stsSeconds: 31536000
        stsIncludeSubdomains: true
        stsPreload: true
        contentTypeNosniff: true
        browserXssFilter: true
        referrerPolicy: "strict-origin-when-cross-origin"

    # 압축
    compress:
      compress: {}

    # Rate Limiting
    rate-limit:
      rateLimit:
        average: 100
        burst: 50
        period: 1s

    # 기본 인증 (대시보드용) - Docker Secret 사용
    auth:
      basicAuth:
        usersFile: /run/secrets/traefik_dashboard_auth

  # ---------------------------------------------------------------------------
  # 라우터 체인 (공통 미들웨어)
  # ---------------------------------------------------------------------------
  routers:
    # Traefik 대시보드 (로컬 전용)
    dashboard:
      rule: "Host(`traefik.localhost`)"
      service: api@internal
      entryPoints:
        - web
      middlewares:
        - auth

    # nextcandle-web 개발 환경
    nextcandle-web-dev:
      rule: "Host(`dev.nextcandle.io`)"
      service: nextcandle-web-dev
      entryPoints:
        - web
      middlewares:
        - compress

    # nextcandle-web 스테이징 환경
    nextcandle-web-stg:
      rule: "Host(`stg.nextcandle.io`)"
      service: nextcandle-web-stg
      entryPoints:
        - web
      middlewares:
        - compress

    # nextcandle-web 프로덕션 환경
    nextcandle-web-prod:
      rule: "Host(`nextcandle.io`)"
      service: nextcandle-web-prod
      entryPoints:
        - web
      middlewares:
        - compress

    nextcandle-web-prod-www:
      rule: "Host(`www.nextcandle.io`)"
      service: nextcandle-web-prod
      entryPoints:
        - web
      middlewares:
        - compress

  # ---------------------------------------------------------------------------
  # 서비스 정의
  # ---------------------------------------------------------------------------
  services:
    nextcandle-web-dev:
      loadBalancer:
        servers:
          - url: "http://nextcandle-web-development:80"

    nextcandle-web-stg:
      loadBalancer:
        servers:
          - url: "http://nextcandle-web-staging:80"

    nextcandle-web-prod:
      loadBalancer:
        servers:
          - url: "http://nextcandle-web-production:80"
